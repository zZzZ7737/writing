# 浏览器渲染的关键路径优化

关键渲染路径是浏览器将 HTML，CSS 和 JavaScript 转换为屏幕上的像素所经历的步骤序列。

**浏览器渲染的关键路径：**

1. [浏览器将 HTML 解析为 **DOM**](https://html.spec.whatwg.org/#overview-of-the-parsing-model)

2. 将 CSS 解析为 **CSSOM**

3. Style: 将 **DOM** 与 **CSSOM** 合并为 **Render Tree**

4. Layout: 根据 **Render Tree** 进行**Layout（布局）**，即计算元素的具体位置（几何信息）。

5. Paint: 布局完成后，就进入到了 **Paint（绘制）** 阶段，将各个节点绘制到屏幕上

6. Compositing（非标准）: 当文档的各个部分以不同的层绘制，相互重叠时，必须进行合成，以确保它们以正确的顺序绘制到屏幕上，并正确显示内容。

   > 为了确保平滑滚动和动画，占据主线程的所有内容：计算样式、回流和绘制，必须让浏览器在 16.67 毫秒内完成。当在 2048x 1536 分辨率的 iPad 上将会有有超过 314.5 万像素将被绘制到屏幕上。为了确保重绘的速度比初始绘制的速度更快，屏幕上的绘图通常被分解成数层。如果发生这种情况，则需要进行合成。
   >
   > 绘制可以将布局树中的元素分解为多个层。将内容提升到 GPU 上的层（而不是 CPU 上的主线程）可以提高绘制和重新绘制性能。有一些特定的属性和元素可以实例化一个层，包括`<video>`和`<canvas>`，任何 CSS 属性为 opacity、3D 转换、will-change 的元素，还有一些其他元素。这些节点将与子节点一起绘制到它们自己的层上，除非子节点由于上述一个（或多个）原因需要自己的层。
   >
   > 层确实可以提高性能，但是它以内存管理为代价，因此不应作为 web 性能优化策略的一部分过度使用。

> 如果 DOM 或 CSSOM 被修改，您只能再执行一遍以上所有步骤，以确定哪些像素需要在屏幕上进行重新渲染。
>
> **_优化关键渲染路径就是指最大限度缩短执行上述第 1 步至第 5 步耗费的总时间。_** 这样一来，就能尽快将内容渲染到屏幕上，此外还能缩短首次渲染后屏幕刷新的时间，即为交互式内容实现更高的刷新率。

很明显，过大的 DOM 树（节点层级深、节点过多）及复杂的 CSS 样式（box-shadow）都会显著的增加上述过程的时间。另外，默认情况下，CSS 被视为阻塞渲染的资源，即除非 CSSOM 构建完成，否则浏览器不会渲染任何内容，**外部引入的 CSS 文件**对这一点的影响更为明显，因为要想构建 CSSOM，就必须等待 CSS 文件下载完成，而文件下载可能比解析更耗时。

不仅 CSS 会阻止渲染，JavaScript 也会阻止 DOM 构建和延缓网页渲染。Javascript 的引入增加了网页的可交互性，但同时也增加了页面渲染复杂度。**JavaScript 拥有修改 DOM 及 CSSOM 的能力，如果浏览器在解析 DOM 的同时去执行会修改 DOM 的 JavaScript 代码，此时，浏览器只能把之前的工作放弃掉，重新解析 DOM，这无疑对性能更不利**。所以浏览器会在解析 JavaScript 的时候暂停 DOM 解析。另外，_如果遇到外部的 JavaScript，解析器还得停下来等待资源下载_，又会增加额外的延迟时间。

- **避免在首屏内容中包含会阻止内容呈现的外部 JavaScript 和 CSS**

  > 浏览器必须先解析网页，然后才能将其呈现给用户。如果浏览器在解析过程中遇到非异步或阻止呈现的外部脚本，则必须停止解析并且下载相应资源。每当发生这种情况时，都会增加一次网络往返过程，这势必会导致网页的首次呈现时间被延迟。
  >
  > 因此，用于呈现首屏内容的 JavaScript 和 CSS 应内嵌到网页中，而用于为网页增添附加功能的 JavaScript 或 CSS 应在 ATF 内容呈现完毕后再开始加载。

- **CSS 媒体查询**

  有些人会疑惑于为什么不能直接解析现有的 HTML 及 CSS 先用于渲染，而需要等待外部引入的 CSS 下载完成后才继续解析？这里直接引用[谷歌 web 开发文档](https://developers.google.com/web/fundamentals/performance/critical-rendering-path/render-blocking-css)

  > 在渲染树构建中，我们看到关键渲染路径要求我们同时具有 DOM 和 CSSOM 才能构建渲染树。这会给性能造成严重影响：HTML 和 CSS 都是阻塞渲染的资源。 HTML 显然是必需的，因为如果没有 DOM，我们就没有可渲染的内容，但 CSS 的必要性可能就不太明显。如果我们在 CSS 不阻塞渲染的情况下尝试渲染一个普通网页会怎样？
  >
  > ![有CSS](./assets/nytimes-css-device.png) ![无CSS](./assets/nytimes-nocss-device.png)
  >
  > 上例展示了纽约时报网站使用和不使用 CSS 的显示效果，它证明了为何要在 CSS 准备就绪之前阻塞渲染，————没有 CSS 的网页实际上无法使用。右侧的情况通常称为“内容样式短暂失效”(FOUC)。浏览器将阻塞渲染，直至 DOM 和 CSSOM 全都准备就绪。

  不过，如果我们有一些 CSS 样式只在特定条件下（例如显示网页或将网页投影到大型显示器上时）使用，又该如何？_如果这些资源不阻塞渲染，该有多好。这样我们可以只下载首屏必须的 CSS 资源了，大大节省了时间（我们甚至可以把首屏的 CSS 资源直接放入 HTML 中）_。

  我们可以通过 **_CSS“媒体类型”和“媒体查询”_** 来解决这类用例：

  ```HTML
  <link href="style.css" rel="stylesheet">
  <link href="print.css" rel="stylesheet" media="print">
  <link href="other.css" rel="stylesheet" media="(min-width: 40em)">
  <link href="portrait.css" rel="stylesheet" media="orientation:portrait">
  ```

- **预加载与预链接**

> 浏览器构建 DOM 树时，这个过程占用了主线程。当这种情况发生时，预加载扫描仪将解析可用的内容并请求高优先级资源，如 CSS、JavaScript 和 web 字体。多亏了预加载扫描器，我们不必等到解析器找到对外部资源的引用来请求它。它将在后台检索资源，以便在主 HTML 解析器到达请求的资源时，它们可能已经在运行，或者已经被下载。预加载扫描仪提供的优化减少了阻塞。

```html
<link rel="preconnect" href="https://www.google.com" />
<link rel="dns-prefetch" href="https://www.google.com" />
```

参考：

- [在 PageSpeed Insights 中针对网站进行移动设备浏览体验分析](https://developers.google.com/speed/docs/insights/mobile)

- [PageSpeed Insights 规则](https://developers.google.com/speed/docs/insights/rules)

- [Optimizing Encoding and Transfer Size of Text-Based Assets](https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/optimize-encoding-and-transfer#text-compression-with-gzip)

- [优化图片](https://developers.google.com/speed/docs/insights/OptimizeImages)

- [Fast Load Times](https://web.dev/fast)

- [阻塞渲染的 CSS](https://developers.google.com/web/fundamentals/performance/critical-rendering-path/render-blocking-css)

- [尽可能减少浏览器重排](https://developers.google.com/speed/docs/insights/browser-reflow)

- [Web 性能 MDN](https://developer.mozilla.org/zh-CN/docs/Web/Performance)

- [浏览器渲染页面的工作原理](https://developer.mozilla.org/zh-CN/docs/Web/Performance/%E6%B5%8F%E8%A7%88%E5%99%A8%E6%B8%B2%E6%9F%93%E9%A1%B5%E9%9D%A2%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86)

- [关键渲染路径](https://developer.mozilla.org/zh-CN/docs/Web/Performance/Critical_rendering_path)

- [HTML Living Standard](https://html.spec.whatwg.org/#overview-of-the-parsing-model)

- [HTML Standard Script](https://html.spec.whatwg.org/#scripting-3)
