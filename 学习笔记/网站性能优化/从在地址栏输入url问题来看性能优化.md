# 从在地址栏输入 url 问题来看前端性能优化

让我们先看看一个经典问题：

## 在浏览器中输入一个网址后，发生了什么？

1. 浏览器通过 DNS 解析查询域名的 ip 地址
2. 向查询到的 IP 地址发起 http 请求
3. 服务器响应请求，并返回资源

4. 浏览器解析返回的 HTML 数据，如果遇到 CSS 或者 JS 资源则暂停解析，等待资源加载完成

5. 浏览器将 HTML 解析为 DOM tree，将 CSS 解析为 CSS tree，之后合并为 Render tree，然后根据 render tree 进行渲染

6. 整个过程结束之后，浏览器关闭 TCP 连接

那么让我们仔细分析上述每个过程，看看哪些地方可以做优化。

### 1. **DNS 查询**

当人们输入域名时，机器不能理解域名，所以需要 DNS 查询。以 xxx.com 域名为例，DNS 查询步骤为：

1. **查找浏览器缓存** - 首先，浏览器会查找自己的缓存
2. **系统缓存** - 如果在浏览器缓存里没有找到需要的记录，浏览器会做一个系统调用来查找这个网址的对应 DNS 信息（我们可以通过 hosts 文件来影响 DNS 查找）
3. **路由器缓存** - 如果在系统缓存中没找到记录，就会发起 DNS 查询请求，请求到路由器时，路由器会查找自己的缓存
4. **ISP DNS 缓存** - isp（互联网服务提供商，例如：中国电信）

5. **递归搜索** - ISP 的 DNS 服务器从根域名服务器开始进行递归搜索，从.com 顶级域名服务器到 xxx 域名服务器

综上，DNS 查询的很大一部分依赖于缓存，所以我们可以通过提高缓存命中率，来优化 DNS 查询，见：[DNS 查询优化](./DNS查询优化.md)

### 2. **发起 http 请求**

当我们真正发起 http 请求后，优化的点就更多了：

- **域名拆分**

  i. 系统的可用资源是有限的（端口数量和线程切换开销），所以不可能允许网页发起无限制的并发请求。浏览器对于并发请求数量的限制是基于域名（domain）的，通常一个域名允许的并发请求数量为 6 个。当网页的并发请求数量大于 6 个时，其余的请求就会被阻塞，而阻塞就意味着性能变差。解决方案是通过 domain hash 技术来增加并发量（因为浏览器是基于 domain 的并发控制，而不是标签页）。

  > ii. 按照普通设计，当网站 cookie 信息有 1 KB、网站首页共 150 个资源时，用户在请求过程中需要发送 150 KB 的 cookie 信息，在 512 Kbps 的常见上行带宽下，需要长达 3 秒左右才能全部发送完毕。 尽管这个过程可以和页面下载不同资源的时间并发，但毕竟对速度造成了影响。 而且这些信息在 js/css/images/flash 等静态资源上，几乎是没有任何必要的。解决方案是启用和主站不同的域名来放置静态资源，也就是 cookie free。

  以上问题的解决方案是启用和主站不同的域名来放置静态资源，既**域名拆分**。但域名拆分并不是越多越好，过多的域名会增加 DNS 查询的时间，可能会产生负优化。

- **http 请求**

### 3. **服务器响应**

- 重定向

> 服务器给浏览器响应一个 301 永久重定向响应，这样浏览器就会访问“http://www.facebook.com/” 而非“http://facebook.com/”。
>
> 为什么服务器一定要重定向而不是直接发会用户想看的网页内容呢？这个问题有好多有意思的答案。
>
> 其中一个原因跟搜索引擎排名有 关。你看，如果一个页面有两个地址，就像http://www.igoro.com/ 和http://igoro.com/，搜索引擎会认为它们是两个网站，结果造成每一个的搜索链接都减少从而降低排名。而搜索引擎知道301永久重定向是 什么意思，这样就会把访问带 www 的和不带 www 的地址归到同一个网站排名下。
>
> 还有一个是用不同的地址会造成缓存友好性变差。当一个页面有好几个名字时，它可能会在缓存里出现好几次。

- 协商缓存

- Gzip

- 开启 KeepAlive

### 4. **浏览器解析 HTML**

- **预加载与预链接**

  ```html
  <link rel="preconnect" href="https://www.google.com" />
  ```

  - **静态资源**

    > 在浏览器显示 HTML 时，它会注意到需要获取其他地址内容的标签。这时，浏览器会 发送一个获取请求来重新获得这些文件。
    >
    > 下面是几个我们访问 facebook.com 时需要重获取的几个 URL：
    >
    > ```
    >  图片
    > http://static.ak.fbcdn.net/rsrc.php/z12E0/hash/8q2anwu7.gif
    > http://static.ak.fbcdn.net/rsrc.php/zBS5C/hash/7hwy7at6.gif
    > …
    > CSS 式样表
    > http://static.ak.fbcdn.net/rsrc.php/z448Z/hash/2plh8s4n.css
    > http://static.ak.fbcdn.net/rsrc.php/zANE1/hash/cvtutcee.css
    > …
    > JavaScript 文件
    > http://static.ak.fbcdn.net/rsrc.php/zEMOA/hash/c8yzb6ub.js
    > http://static.ak.fbcdn.net/rsrc.php/z6R9L/hash/cq2lgbs8.js
    > …
    > ```
    >
    > 这些地址都要经历一个和 HTML 读取类似的过程。所以浏览器会在 DNS 中查找这些 域名，发送请求，重定向等等...
    >
    > 但 不像动态页面那样，静态文件会允许浏览器对其进行缓存。有的文件可能会不需 要与服务器通讯，而从缓存中直接读取。服务器的响应中包含了静态文件保存的期限 信息，所以浏览器知道要把它们缓存多长时间。还有，每个响应都可能包含像版本号一 样工作的 ETag 头（被请求变量的实体值），如果浏览器观察到文件的版本 ETag 信息 已经存在，就马上停止这个文件的传输。
    >
    > 试着猜猜看“fbcdn.net”在地址中代表什么？聪明的答案是"Facebook 内容分发网络 "。Facebook 利用内容分发网络（CDN）分发像图片，CSS 表和 JavaScript 文件这些 静态文件。所以，这些文件会在全球很多 CDN 的数据中心中留下备份。
    >
    > 静态内容往往代表站点的带宽大小，也能通过 CDN 轻松的复制。通常网站会使用第 三方的 CDN。例如，Facebook 的静态文件由最大的 CDN 提供商 Akamai 来托管。
    >
    > 举例来讲，当你试着 ping static.ak.fbcdn.net 的时候，可能会从某个 akamai. net 服务器上获得响应。有意思的是，当你同样再 ping 一次的时候，响应的服务器可 能就不一样，这说明幕后的负载平衡开始起作用了。

参考：

- [浏览器允许的并发请求资源数是什么意思？ - 黄良懿的回答 - 知乎
  ](https://www.zhihu.com/question/20474326/answer/15696641)

- [并发连接数对浏览器加载速度的测试](https://www.iefans.net/bingfa-lianjieshu-sudu-ceshi/)

- [常见的前端性能优化手段都有哪些？都有多大收益？](https://www.zhihu.com/question/40505685)
